<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Reset & Base Styles --- */
        :root {
            --bg-color: #f4f4f5;
            --card-bg: #ffffff;
            --primary: #18181b;
            --primary-light: #3f3f46;
            --secondary: #71717a;
            --border-color: #e4e4e7;
            --success: #16a34a;
            --error: #dc2626;
            --font-family: 'Inter', sans-serif;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        button, input {
            font-family: inherit;
        }
        input:focus {
            outline: none;
        }

        /* --- Main Containers --- */
        .app-container {
            display: none; /* Hidden by default, shown after auth */
            flex-direction: column;
            height: 100%;
            background-color: var(--bg-color);
        }
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 24px;
            background-color: var(--card-bg);
        }

        /* --- Login Screen Styles --- */
        .login-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary);
        }
        .login-subtitle {
            font-size: 16px;
            color: var(--secondary);
            margin-bottom: 32px;
            text-align: center;
        }
        .login-form {
            width: 100%;
            max-width: 400px;
        }
        .login-input {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 16px;
            background-color: var(--bg-color);
        }
        .login-input:focus {
            border-color: var(--primary);
        }
        .login-button {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background-color: var(--primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .login-button:hover {
            background-color: var(--primary-light);
        }
        .error-message {
            color: var(--error);
            margin-top: 16px;
            text-align: center;
            font-weight: 500;
        }

        /* --- Admin Panel Header --- */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .admin-header-title {
            font-size: 18px;
            font-weight: 600;
        }
        .logout-button {
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary);
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* --- Search Bar --- */
        .search-container {
            padding: 16px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .search-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--bg-color);
        }

        /* --- Product List --- */
        .product-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .product-card {
            background-color: var(--card-bg);
            border-radius: 16px;
            margin-bottom: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .product-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background-color: var(--bg-color);
        }
        .product-details {
            flex: 1;
        }
        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }
        .product-price-current {
            font-size: 14px;
            color: var(--secondary);
        }
        .product-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .price-input {
            flex-grow: 1;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            /* For numeric keyboard on mobile */
            -moz-appearance: textfield;
        }
        .price-input::-webkit-outer-spin-button,
        .price-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .update-button {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background-color: var(--primary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
        }
        .update-button.success {
            background-color: var(--success);
        }

        /* --- Loader / Spinner --- */
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Global Loader --- */
        .global-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .global-loader .loader {
            width: 40px;
            height: 40px;
            border-color: rgba(0,0,0,0.1);
            border-top-color: var(--primary);
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-container" class="login-container">
        <h1 class="login-title">Panneau Admin</h1>
        <p class="login-subtitle">Connectez-vous pour gérer les produits.</p>
        <form id="login-form" class="login-form">
            <input type="email" id="email" class="login-input" placeholder="Email" required>
            <input type="password" id="password" class="login-input" placeholder="Mot de passe" required>
            <button type="submit" class="login-button">Se connecter</button>
        </form>
        <p id="login-error" class="error-message" style="display: none;"></p>
    </div>

    <!-- Main Admin Panel (initially hidden) -->
    <div id="app-container" class="app-container">
        <header class="admin-header">
            <h1 class="admin-header-title">Gestion des Prix</h1>
            <button id="logout-button" class="logout-button">Déconnexion</button>
        </header>
        
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="Rechercher un produit...">
        </div>

        <main id="product-list" class="product-list">
            <!-- Product cards will be injected here by JavaScript -->
            <div class="global-loader">
                <div class="loader"></div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // IMPORTANT: Remplacez cet objet par la configuration de votre projet Firebase
        // Vous pouvez la trouver dans votre console Firebase > Paramètres du projet > Général > Vos applications > SDK setup and configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDNYwc40OWGXHrOOqqPYTB_jDGJmI7Mc1M", // Trouvé dans google-services.json
            authDomain: "africaphone-vente.firebaseapp.com",
            projectId: "africaphone-vente", // Trouvé dans google-services.json
            storageBucket: "africaphone-vente.appspot.com", // Trouvé dans google-services.json
            messagingSenderId: "203471818329", // project_number dans google-services.json
            appId: "1:203471818329:web:xxxxxxxxxxxxxxxxxxxxxx" // Vous devez créer une app Web dans Firebase pour obtenir ceci
        };

        // Importation des fonctions nécessaires des SDKs Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Références aux éléments du DOM
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const productListContainer = document.getElementById('product-list');
        const searchInput = document.getElementById('search-input');

        let allProducts = []; // Cache pour la recherche

        // --- AUTHENTIFICATION ---

        // Écouteur pour les changements d'état de connexion
        onAuthStateChanged(auth, user => {
            if (user) {
                // Si l'utilisateur est connecté, on affiche le panneau admin
                loginContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                loadProducts();
            } else {
                // Sinon, on affiche l'écran de connexion
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        // Gestion de la soumission du formulaire de connexion
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.style.display = 'none';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged s'occupera du reste
            } catch (error) {
                loginError.textContent = "Email ou mot de passe incorrect.";
                loginError.style.display = 'block';
                console.error("Login Error:", error);
            }
        });

        // Gestion de la déconnexion
        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // --- GESTION DES PRODUITS ---

        // Fonction pour charger et afficher les produits depuis Firestore
        async function loadProducts() {
            productListContainer.innerHTML = `<div class="global-loader"><div class="loader"></div></div>`;
            try {
                const productsRef = collection(db, "products");
                // On trie les produits par nom pour un affichage cohérent
                const q = query(productsRef, orderBy("name"));
                const querySnapshot = await getDocs(q);
                
                allProducts = []; // Vider le cache
                productListContainer.innerHTML = ''; // Vider la liste

                if (querySnapshot.empty) {
                    productListContainer.innerHTML = '<p>Aucun produit trouvé.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const product = { id: doc.id, ...doc.data() };
                    allProducts.push(product);
                    const productCard = createProductCard(product);
                    productListContainer.appendChild(productCard);
                });

            } catch (error) {
                console.error("Error loading products:", error);
                productListContainer.innerHTML = '<p style="color: var(--error);">Erreur lors du chargement des produits.</p>';
            }
        }
        
        // Fonction pour créer une carte produit HTML
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.productId = product.id;
            card.dataset.productName = product.name.toLowerCase();

            const currentPriceFormatted = new Intl.NumberFormat('fr-FR').format(product.price) + ' FCFA';

            card.innerHTML = `
                <div class="product-info">
                    <img src="${product.imageUrl}" alt="${product.name}" class="product-image" loading="lazy">
                    <div class="product-details">
                        <p class="product-name">${product.name}</p>
                        <p class="product-price-current">Actuel : ${currentPriceFormatted}</p>
                    </div>
                </div>
                <div class="product-actions">
                    <input type="number" class="price-input" placeholder="Nouveau prix" value="${product.price}">
                    <button class="update-button">Mettre à jour</button>
                </div>
            `;

            // Ajout de l'écouteur d'événement pour le bouton "Mettre à jour"
            const updateButton = card.querySelector('.update-button');
            updateButton.addEventListener('click', () => handlePriceUpdate(product.id, card));

            return card;
        }

        // Fonction pour gérer la mise à jour du prix
        async function handlePriceUpdate(productId, cardElement) {
            const input = cardElement.querySelector('.price-input');
            const button = cardElement.querySelector('.update-button');
            const newPrice = parseFloat(input.value);

            if (isNaN(newPrice) || newPrice < 0) {
                alert("Veuillez entrer un prix valide.");
                return;
            }

            // Afficher un loader sur le bouton
            button.innerHTML = '<div class="loader"></div>';
            button.disabled = true;

            try {
                const productRef = doc(db, "products", productId);
                await updateDoc(productRef, {
                    price: newPrice
                });
                
                // Feedback visuel de succès
                button.innerHTML = '✓';
                button.classList.add('success');
                
                // Mettre à jour le texte du prix actuel
                const currentPriceElement = cardElement.querySelector('.product-price-current');
                currentPriceElement.textContent = `Actuel : ${new Intl.NumberFormat('fr-FR').format(newPrice)} FCFA`;

                // Revenir à l'état initial après un court délai
                setTimeout(() => {
                    button.innerHTML = 'Mettre à jour';
                    button.classList.remove('success');
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error("Error updating price:", error);
                alert("Erreur lors de la mise à jour.");
                button.innerHTML = 'Mettre à jour';
                button.disabled = false;
            }
        }

        // --- RECHERCHE ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const allCards = productListContainer.querySelectorAll('.product-card');
            
            allCards.forEach(card => {
                const productName = card.dataset.productName;
                if (productName.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });

    </script>
</body>
</html>
