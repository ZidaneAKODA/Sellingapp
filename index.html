<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />
  <title>Panneau Admin</title>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg: #f6f7f8;
      --card: #ffffff;
      --ink: #0f172a; /* slate-900 */
      --ink-2: #334155; /* slate-700 */
      --muted: #64748b; /* slate-500 */
      --border: #e5e7eb;
      --primary: #111827; /* gray-900 */
      --primary-2: #1f2937; /* gray-800 */
      --accent: #2563eb; /* blue-600 */
      --success: #16a34a;
      --error: #dc2626;
      --warning: #f59e0b;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --shadow-1: 0 1px 2px rgba(0,0,0,0.06), 0 8px 24px rgba(15,23,42,0.06);
      --shadow-2: 0 1px 2px rgba(0,0,0,0.06), 0 12px 32px rgba(15,23,42,0.08);
      --focus: 0 0 0 3px rgba(37,99,235,0.18);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--primary);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Auth */
    .login-container {
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: 24px;
      background: var(--card);
    }
    .login-card {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-1);
    }
    .login-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; }
    .login-sub { color: var(--muted); margin-bottom: 20px; }
    .field {
      display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px;
    }
    .label { font-size: 14px; color: var(--ink-2); font-weight: 600; }
    .input {
      height: 46px;
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: var(--radius-md);
      padding: 0 14px;
      font-size: 15px;
      transition: box-shadow .15s, border-color .15s, background .15s;
    }
    .input:focus { outline: none; border-color: #cbd5e1; box-shadow: var(--focus); background: #fff; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 10px;
      height: 46px; padding: 0 16px; border: none; cursor: pointer;
      border-radius: var(--radius-md); font-weight: 700; font-size: 15px;
      transition: transform .06s ease, box-shadow .2s ease, background-color .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: var(--shadow-1); }
    .btn-primary:hover { background: var(--primary-2); }
    .error { color: var(--error); font-weight: 600; text-align: center; margin-top: 10px; }

    /* App Shell */
    .app {
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto auto 1fr;
    }
    .header {
      position: sticky; top: 0; z-index: 20;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 10px 14px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-weight: 800; letter-spacing: .2px; font-size: 18px; }
    .header-actions { display: flex; gap: 10px; }
    .btn-ghost {
      background: #f8fafc; color: var(--primary); border: 1px solid var(--border);
    }
    .toolbar {
      position: sticky; top: 56px; z-index: 19;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr auto;
      gap: 10px; padding: 10px 14px;
    }
    @media (min-width: 768px) {
      .toolbar { grid-template-columns: 1fr auto auto; }
    }
    .search {
      height: 44px; border: 1px solid var(--border); background: #f8fafc;
      border-radius: var(--radius-md); padding: 0 14px; font-size: 15px;
    }
    .btn-add { background: var(--accent); color: #fff; }
    .hint { align-self: center; color: var(--muted); font-size: 13px; display: none; }
    @media (min-width: 768px) { .hint { display: inline-block; } }

    .content {
      padding: 14px;
    }

    /* ===== LISTE (pas de grille) ===== */
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-1);
      min-height: 76px;
      flex-wrap: wrap; /* mobile: passe en lignes */
    }

    .thumb {
      width: 56px; height: 56px; border-radius: 10px; object-fit: cover; background: #f1f5f9;
      flex: 0 0 56px;
    }

    .info {
      display: grid; gap: 4px; min-width: 160px;
    }
    .title { font-weight: 700; font-size: 16px; line-height: 1.2; }
    .sub { color: var(--muted); font-size: 13px; }

    .spacer { flex: 1 1 auto; min-width: 16px; }

    .price-line {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    .price-input {
      height: 42px; border: 1px solid var(--border); background: #f8fafc; border-radius: var(--radius-sm);
      padding: 0 12px; font-size: 15px; width: 140px; -moz-appearance: textfield;
    }
    .price-input::-webkit-outer-spin-button, .price-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .actions {
      display: flex; gap: 8px; align-items: center;
      margin-left: auto;
    }
    /* Sur petits écrans: placer prix + actions sur une nouvelle ligne */
    @media (max-width: 640px) {
      .actions { width: 100%; justify-content: flex-end; }
    }

    .btn-update { background: var(--primary); color: #fff; }
    .btn-edit { background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; }
    .btn-delete { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    .loader {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,.35); border-top-color: #fff;
      animation: spin 1s linear infinite;
    }
    .loader-dark {
      width: 28px; height: 28px; border: 3px solid rgba(0,0,0,.1); border-top-color: var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .center {
      min-height: 40vh; display: grid; place-items: center; color: var(--muted);
    }

    /* EDIT PAGE */
    .edit-wrap {
      max-width: 860px; margin: 0 auto;
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow-2);
    }
    .edit-head {
      display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 8px;
    }
    .edit-title { font-weight: 800; font-size: 18px; }
    .edit-form { display: grid; gap: 12px; margin-top: 8px; }
    .twocol {
      display: grid; gap: 12px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 640px) { .twocol { grid-template-columns: 1fr; } }
    .textarea {
      min-height: 120px; resize: vertical; padding: 12px;
      border: 1px solid var(--border); background: #f8fafc; border-radius: var(--radius-md);
      font-size: 15px;
    }
    .edit-actions {
      margin-top: 6px; display: flex; gap: 10px; justify-content: flex-end;
    }
    .btn-outline { background: #fff; color: var(--primary); border: 1px solid var(--border); }
    .kpi {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 999px; background: #f1f5f9; color: #0f172a; font-weight: 700; font-size: 13px;
      border: 1px solid var(--border);
    }

    /* Small helpers */
    .hide { display: none !important; }
    .text-danger { color: var(--error); }
    .text-muted { color: var(--muted); }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login" class="login-container">
    <div class="login-card">
      <h1 class="login-title">Panneau Admin</h1>
      <p class="login-sub">Connectez-vous pour gérer les produits.</p>
      <form id="login-form">
        <div class="field">
          <label class="label" for="email">Email</label>
          <input id="email" type="email" class="input" placeholder="ex: admin@exemple.com" required />
        </div>
        <div class="field">
          <label class="label" for="password">Mot de passe</label>
          <input id="password" type="password" class="input" placeholder="••••••••" required />
        </div>
        <button class="btn btn-primary" type="submit">Se connecter</button>
      </form>
      <p id="login-error" class="error hide"></p>
    </div>
  </div>

  <!-- APP SHELL -->
  <div id="app" class="app" style="display:none;">
    <header class="header">
      <div class="brand">Gestion des Produits</div>
      <div class="header-actions">
        <button id="logout" class="btn btn-ghost">Déconnexion</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="search" class="search" type="text" placeholder="Rechercher un produit..." />
      <span class="hint">Astuce : tapez le nom du modèle, ex. “iPhone 12”.</span>
      <button id="back-to-list" class="btn btn-outline hide">Retour à la liste</button>
    </div>

    <main id="view" class="content">
      <!-- ROUTER VIEW -->
      <div class="center" id="loading">
        <div class="loader-dark"></div>
      </div>
    </main>
  </div>

  <script type="module">
    /* -------------------- Firebase -------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDNYwc40OWGXHrOOqqPYTB_jDGJmI7Mc1M",
      authDomain: "africaphone-vente.firebaseapp.com",
      projectId: "africaphone-vente",
      storageBucket: "africaphone-vente.appspot.com",
      messagingSenderId: "203471818329",
      appId: "1:203471818329:web:c2c77d48098c1a6a596b48"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);

    /* -------------------- DOM -------------------- */
    const $login = document.getElementById('login');
    const $loginForm = document.getElementById('login-form');
    const $loginError = document.getElementById('login-error');

    const $app = document.getElementById('app');
    const $view = document.getElementById('view');
    const $loading = document.getElementById('loading');
    const $logout = document.getElementById('logout');
    const $search = document.getElementById('search');
    const $backToList = document.getElementById('back-to-list');

    /* -------------------- State -------------------- */
    let allProducts = [];      // cache liste
    let searchTerm = "";       // filtre live

    const TRASH_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;

    /* -------------------- Auth flow -------------------- */
    onAuthStateChanged(auth, (user) => {
      if (user) {
        $login.style.display = 'none';
        $app.style.display = 'grid';
        if (!location.hash) location.hash = '#/products';
        router(); // affiche la vue courante
      } else {
        $app.style.display = 'none';
        $login.style.display = 'grid';
      }
    });

    $loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        $loginError.textContent = "Email ou mot de passe incorrect.";
        $loginError.classList.remove('hide');
      }
    });

    $logout.addEventListener('click', () => signOut(auth));

    /* -------------------- Router -------------------- */
    window.addEventListener('hashchange', router);

    async function router() {
      const hash = location.hash || '#/products';
      const [_, route, id] = hash.split('/'); // ["#", "products" | "edit", ":id"]

      // UI adaptative toolbar
      if (route === 'edit') {
        $backToList.classList.remove('hide');
      } else {
        $backToList.classList.add('hide');
      }

      if (route === 'products') {
        showLoading();
        await loadProductsOnce();
        renderList();
        hideLoading();
      } else if (route === 'edit' && id) {
        showLoading();
        await renderEditPage(id);
        hideLoading();
      } else {
        // fallback
        location.hash = '#/products';
      }
    }

    $backToList.addEventListener('click', () => {
      location.hash = '#/products';
    });

    function showLoading() {
      $view.innerHTML = '';
      $view.appendChild($loading);
      $loading.classList.remove('hide');
    }
    function hideLoading() {
      $loading.classList.add('hide');
    }

    /* -------------------- Data -------------------- */
    async function loadProductsOnce() {
      if (allProducts.length) return; // déjà en cache
      try {
        const q = query(collection(db, "products"), orderBy("name"));
        const snap = await getDocs(q);
        allProducts = [];
        snap.forEach(d => allProducts.push({ id: d.id, ...d.data() }));
      } catch (e) {
        console.error(e);
        $view.innerHTML = `<div class="center"><span class="text-danger">Erreur de chargement.</span></div>`;
      }
    }

    async function refreshProducts() {
      allProducts = [];
      const q = query(collection(db, "products"), orderBy("name"));
      const snap = await getDocs(q);
      snap.forEach(d => allProducts.push({ id: d.id, ...d.data() }));
    }

    function productById(id) {
      return allProducts.find(p => p.id === id);
    }

    /* -------------------- LIST VIEW -------------------- */
    function renderList() {
      const wrap = document.createElement('div');
      wrap.className = 'list';
      const filtered = allProducts.filter(p =>
        (p.name || '').toLowerCase().includes(searchTerm)
      );

      if (!filtered.length) {
        $view.innerHTML = `<div class="center">Aucun produit ne correspond à “${escapeHtml(searchTerm)}”.</div>`;
        return;
      }

      filtered.forEach(p => {
        wrap.appendChild(productRow(p));
      });

      $view.innerHTML = '';
      $view.appendChild(wrap);
    }

    function productRow(product) {
      const row = document.createElement('div');
      row.className = 'item';
      row.dataset.productId = product.id;
      row.dataset.productName = (product.name || '').toLowerCase();

      const specs = `Specs : ${(product.rom ?? '?')}GB ROM / ${(product.ram ?? '?')}GB RAM`;

      row.innerHTML = `
        <img class="thumb" src="${escapeAttr(product.imageUrl || '')}" alt="${escapeAttr(product.name || 'Produit')}" loading="lazy" />
        <div class="info" style="min-width:0;">
          <div class="title">${escapeHtml(product.name || 'Sans nom')}</div>
          <div class="sub">${escapeHtml(specs)}</div>
        </div>

        <div class="spacer"></div>

        <div class="price-line">
          <input type="number" class="price-input" placeholder="Nouveau prix" value="${Number(product.price ?? 0)}" />
          <button class="btn btn-update">Mettre à jour</button>
        </div>

        <div class="actions">
          <button class="btn btn-edit">Éditer</button>
          <button class="btn btn-delete" title="Supprimer">${TRASH_ICON_SVG}</button>
        </div>
      `;

      // events
      const $btnUpdate = row.querySelector('.btn-update');
      const $priceInput = row.querySelector('.price-input');
      const $btnEdit = row.querySelector('.btn-edit');
      const $btnDelete = row.querySelector('.btn-delete');

      $btnUpdate.addEventListener('click', () => handlePriceUpdate(product.id, $priceInput, $btnUpdate));
      $btnEdit.addEventListener('click', () => { location.hash = `#/edit/${product.id}`; });
      $btnDelete.addEventListener('click', () => handleDelete(product.id, product.name, row));

      return row;
    }

    async function handlePriceUpdate(id, $input, $button) {
      const val = parseFloat($input.value);
      if (isNaN(val) || val < 0) {
        alert('Veuillez entrer un prix valide.'); return;
      }
      const prevHTML = $button.innerHTML;
      $button.innerHTML = '<div class="loader"></div>';
      $button.disabled = true;
      try {
        await updateDoc(doc(db, 'products', id), { price: val });
        // mets à jour le cache + UI locale
        const p = productById(id);
        if (p) p.price = val;
        $button.textContent = '✓';
        $button.style.background = 'var(--success)';
        setTimeout(() => {
          $button.textContent = 'Mettre à jour';
          $button.style.background = 'var(--primary)';
          $button.disabled = false;
        }, 1200);
      } catch (e) {
        console.error(e);
        alert("Erreur lors de la mise à jour du prix.");
        $button.innerHTML = prevHTML;
        $button.disabled = false;
      }
    }

    async function handleDelete(id, name, rowEl) {
      if (!confirm(`Supprimer “${name || 'Produit'}” ?`)) return;
      const prev = rowEl.innerHTML;
      rowEl.style.opacity = '.6';
      try {
        await deleteDoc(doc(db, 'products', id));
        // retire du cache & UI
        allProducts = allProducts.filter(p => p.id !== id);
        rowEl.style.transition = 'opacity .25s ease';
        rowEl.style.opacity = '0';
        setTimeout(() => rowEl.remove(), 200);
      } catch (e) {
        console.error(e);
        alert("Erreur lors de la suppression.");
        rowEl.innerHTML = prev;
        rowEl.style.opacity = '1';
      }
    }

    /* Recherche instantanée */
    $search.addEventListener('input', (e) => {
      searchTerm = (e.target.value || '').toLowerCase();
      if ((location.hash || '').startsWith('#/products')) {
        renderList();
      }
    });

    /* -------------------- EDIT VIEW (PAGE) -------------------- */
    async function renderEditPage(id) {
      // récup produit (cache ou fetch direct si pas trouvé)
      let product = productById(id);
      if (!product) {
        try {
          const snap = await getDoc(doc(db, 'products', id));
          if (snap.exists()) product = { id: snap.id, ...snap.data() };
        } catch (e) {
          console.error(e);
        }
      }
      if (!product) {
        $view.innerHTML = `<div class="center"><span class="text-danger">Produit introuvable.</span></div>`;
        return;
      }

      const wrap = document.createElement('div');
      wrap.className = 'edit-wrap';

      wrap.innerHTML = `
        <div class="edit-head">
          <div class="edit-title">Modifier le produit</div>
          <span class="kpi">ID: ${escapeHtml(product.id.slice(0,8))}…</span>
        </div>

        <form id="edit-form" class="edit-form">
          <div class="field">
            <label class="label" for="p-name">Nom du produit</label>
            <input id="p-name" class="input" type="text" value="${escapeAttr(product.name || '')}" required />
          </div>

          <div class="twocol">
            <div class="field">
              <label class="label" for="p-price">Prix</label>
              <input id="p-price" class="input" type="number" min="0" step="0.01" value="${Number(product.price ?? 0)}" />
            </div>
            <div class="field">
              <label class="label" for="p-image">Image URL</label>
              <input id="p-image" class="input" type="url" placeholder="https://…" value="${escapeAttr(product.imageUrl || '')}" />
            </div>
          </div>

          <div class="twocol">
            <div class="field">
              <label class="label" for="p-ram">RAM (GB)</label>
              <input id="p-ram" class="input" type="number" min="0" step="1" value="${Number(product.ram ?? '')}" />
            </div>
            <div class="field">
              <label class="label" for="p-rom">ROM (GB)</label>
              <input id="p-rom" class="input" type="number" min="0" step="1" value="${Number(product.rom ?? '')}" />
            </div>
          </div>

          <div class="field">
            <label class="label" for="p-desc">Description</label>
            <textarea id="p-desc" class="textarea" placeholder="Détails du produit…">${escapeHtml(product.description || '')}</textarea>
          </div>

          <div class="edit-actions">
            <button type="button" id="cancel" class="btn btn-outline">Annuler</button>
            <button type="submit" id="save" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      `;

      $view.innerHTML = '';
      $view.appendChild(wrap);

      const $form = document.getElementById('edit-form');
      const $save = document.getElementById('save');
      const $cancel = document.getElementById('cancel');

      $cancel.addEventListener('click', () => {
        location.hash = '#/products';
      });

      $form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
          name: document.getElementById('p-name').value.trim(),
          price: parseFloat(document.getElementById('p-price').value || '0'),
          imageUrl: document.getElementById('p-image').value.trim(),
          ram: parseInt(document.getElementById('p-ram').value || '0', 10),
          rom: parseInt(document.getElementById('p-rom').value || '0', 10),
          description: document.getElementById('p-desc').value.trim()
        };

        // petite validation
        if (!payload.name) { alert('Le nom est obligatoire.'); return; }
        if (isNaN(payload.price) || payload.price < 0) { alert('Prix invalide.'); return; }
        if (isNaN(payload.ram)) payload.ram = null;
        if (isNaN(payload.rom)) payload.rom = null;

        const prev = $save.textContent;
        $save.innerHTML = '<div class="loader"></div>';
        $save.disabled = true;

        try {
          await updateDoc(doc(db, 'products', id), payload);
          // maj cache
          const idx = allProducts.findIndex(p => p.id === id);
          if (idx > -1) allProducts[idx] = { ...allProducts[idx], ...payload };

          // feedback
          $save.textContent = '✓ Enregistré';
          $save.style.background = 'var(--success)';
          setTimeout(async () => {
            $save.textContent = prev;
            $save.style.background = 'var(--primary)';
            $save.disabled = false;
            // Retour à la liste et raffraîchit
            await refreshProducts();
            location.hash = '#/products';
          }, 900);
        } catch (e) {
          console.error(e);
          alert("Erreur d'enregistrement.");
          $save.textContent = prev;
          $save.disabled = false;
        }
      });
    }

    /* -------------------- Utils -------------------- */
    function escapeHtml(s='') {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function escapeAttr(s='') {
      return escapeHtml(s).replaceAll('`', '&#96;');
    }
  </script>
</body>
</html>
