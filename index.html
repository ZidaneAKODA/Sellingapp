<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />
  <title>Panneau Admin</title>

  <!-- Favicon to avoid 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' rx='12' fill='%23111827'/%3E%3Ctext x='50%25' y='55%25' font-size='36' text-anchor='middle' fill='white' font-family='Inter,Arial,sans-serif'%3EA%3C/text%3E%3C/svg%3E" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg: #f6f7f8;
      --card: #ffffff;
      --ink: #0f172a; /* slate-900 */
      --ink-2: #334155; /* slate-700 */
      --muted: #64748b; /* slate-500 */
      --border: #e5e7eb;
      --primary: #111827; /* gray-900 */
      --primary-2: #1f2937; /* gray-800 */
      --accent: #2563eb; /* blue-600 */
      --success: #16a34a;
      --error: #dc2626;
      --warning: #f59e0b;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
      --shadow-1: 0 1px 2px rgba(0,0,0,0.06), 0 8px 24px rgba(15,23,42,0.06);
      --shadow-2: 0 1px 2px rgba(0,0,0,0.06), 0 12px 32px rgba(15,23,42,0.08);
      --focus: 0 0 0 3px rgba(37,99,235,0.18);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--primary);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Auth */
    .login-container {
      min-height: 100dvh;
      display: grid;
      place-items: center;
      padding: 24px;
      background: var(--card);
    }
    .login-card {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-1);
    }
    .login-title { font-size: 24px; font-weight: 700; margin-bottom: 6px; }
    .login-sub { color: var(--muted); margin-bottom: 20px; }
    .field {
      display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px;
    }
    .label { font-size: 14px; color: var(--ink-2); font-weight: 600; }
    .input {
      height: 46px;
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: var(--radius-md);
      padding: 0 14px;
      font-size: 15px;
      transition: box-shadow .15s, border-color .15s, background .15s;
    }
    .input:focus { outline: none; border-color: #cbd5e1; box-shadow: var(--focus); background: #fff; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 10px;
      height: 46px; padding: 0 16px; border: none; cursor: pointer;
      border-radius: var(--radius-md); font-weight: 700; font-size: 15px;
      transition: transform .06s ease, box-shadow .2s ease, background-color .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: var(--shadow-1); }
    .btn-primary:hover { background: var(--primary-2); }
    .error { color: var(--error); font-weight: 600; text-align: center; margin-top: 10px; }

    /* App Shell */
    .app {
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto auto 1fr;
    }
    .header {
      position: sticky; top: 0; z-index: 20;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 10px 14px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { font-weight: 800; letter-spacing: .2px; font-size: 18px; }
    .header-actions { display: flex; gap: 10px; }
    .btn-ghost {
      background: #f8fafc; color: var(--primary); border: 1px solid var(--border);
    }
    .toolbar {
      position: sticky; top: 56px; z-index: 19;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr auto;
      gap: 10px; padding: 10px 14px;
    }
    @media (min-width: 768px) {
      .toolbar { grid-template-columns: 1fr auto auto auto; } /* Ajout d'une colonne */
    }
    .search {
      height: 44px; border: 1px solid var(--border); background: #f8fafc;
      border-radius: var(--radius-md); padding: 0 14px; font-size: 15px;
    }
    .btn-add { background: var(--accent); color: #fff; }
    .hint { align-self: center; color: var(--muted); font-size: 13px; display: none; }
    @media (min-width: 768px) { .hint { display: inline-block; } }

    .content {
      padding: 14px;
    }

    /* ===== LISTE (pas de grille) ===== */
    .list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-1);
      min-height: 76px;
      flex-wrap: wrap; /* mobile: passe en lignes */
    }

    .thumb {
      width: 56px; height: 56px; border-radius: 10px; object-fit: cover; background: #f1f5f9;
      flex: 0 0 56px;
    }

    .info {
      display: grid; gap: 4px; min-width: 160px;
    }
    .title { font-weight: 700; font-size: 16px; line-height: 1.2; }
    .sub { color: var(--muted); font-size: 13px; }

    .spacer { flex: 1 1 auto; min-width: 16px; }

    .price-line {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    .price-input {
      height: 42px; border: 1px solid var(--border); background: #f8fafc; border-radius: var(--radius-sm);
      padding: 0 12px; font-size: 15px; width: 140px; -moz-appearance: textfield;
    }
    .price-input::-webkit-outer-spin-button, .price-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    .actions {
      display: flex; gap: 8px; align-items: center;
      margin-left: auto;
    }
    /* Sur petits écrans: placer prix + actions sur une nouvelle ligne */
    @media (max-width: 640px) {
      .actions { width: 100%; justify-content: flex-end; }
    }

    .btn-update { background: var(--primary); color: #fff; }
    .btn-edit { background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; }
    .btn-delete { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    .loader {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,.35); border-top-color: #fff;
      animation: spin 1s linear infinite;
    }
    .loader-dark {
      width: 28px; height: 28px; border: 3px solid rgba(0,0,0,.1); border-top-color: var(--primary);
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .center {
      min-height: 40vh; display: grid; place-items: center; color: var(--muted);
    }

    /* EDIT & CREATE PAGE */
    .form-wrap {
      max-width: 860px; margin: 0 auto;
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 16px; box-shadow: var(--shadow-2);
    }
    .form-head {
      display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 8px;
    }
    .form-title { font-weight: 800; font-size: 18px; }
    .form-main { display: grid; gap: 12px; margin-top: 8px; }
    .twocol {
      display: grid; gap: 12px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 640px) { .twocol { grid-template-columns: 1fr; } }
    .textarea {
      min-height: 120px; resize: vertical; padding: 12px;
      border: 1px solid var(--border); background: #f8fafc; border-radius: var(--radius-md);
      font-size: 15px;
    }
    .form-actions {
      margin-top: 6px; display: flex; gap: 10px; justify-content: flex-end;
    }
    .btn-outline { background: #fff; color: var(--primary); border: 1px solid var(--border); }
    .kpi {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 999px; background: #f1f5f9; color: #0f172a; font-weight: 700; font-size: 13px;
      border: 1px solid var(--border);
    }
    .image-preview {
      width: 100px; height: 100px; border-radius: var(--radius-md); object-fit: cover;
      border: 1px solid var(--border); background: #f8fafc;
    }

    /* Small helpers */
    .hide { display: none !important; }
    .text-danger { color: var(--error); }
    .text-muted { color: var(--muted); }
  </style>
</head>
<body>

  <div id="login" class="login-container">
    <div class="login-card">
      <h1 class="login-title">Panneau Admin</h1>
      <p class="login-sub">Connectez-vous pour gérer les produits.</p>
      <form id="login-form">
        <div class="field">
          <label class="label" for="email">Email</label>
          <input id="email" type="email" class="input" placeholder="ex: admin@exemple.com" required />
        </div>
        <div class="field">
          <label class="label" for="password">Mot de passe</label>
          <input id="password" type="password" class="input" placeholder="••••••••" required />
        </div>
        <button class="btn btn-primary" type="submit">Se connecter</button>
      </form>
      <p id="login-error" class="error hide"></p>
    </div>
  </div>

  <div id="app" class="app" style="display:none;">
    <header class="header">
      <div class="brand">Gestion des Produits</div>
      <div class="header-actions">
        <button id="logout" class="btn btn-ghost">Déconnexion</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="search" class="search" type="text" placeholder="Rechercher un produit..." />
      <span class="hint">Astuce : tapez le nom du modèle.</span>
      <button id="back-to-list" class="btn btn-outline hide">Retour à la liste</button>
      <button id="add-product-btn" class="btn btn-add">Nouvel Article</button>
    </div>

    <main id="view" class="content">
      <div class="center" id="loading">
        <div class="loader-dark"></div>
      </div>
    </main>
  </div>

  <script type="module">
    /* -------------------- Firebase -------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDNYwc40OWGXHrOOqqPYTB_jDGJmI7Mc1M",
      authDomain: "africaphone-vente.firebaseapp.com",           // FIXED
      projectId: "africaphone-vente",
      storageBucket: "africaphone-vente.firebasestorage.app",            // FIXED
      messagingSenderId: "203471818329",
      appId: "1:203471818329:web:c2c77d48098c1a6a596b48"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, addDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db = getFirestore(appFB);
    const storage = getStorage(appFB);

    /* -------------------- DOM & State -------------------- */
    const $ = (selector) => document.querySelector(selector);
    const $login = $('#login'), $loginForm = $('#login-form'), $loginError = $('#login-error');
    const $app = $('#app'), $view = $('#view'), $loading = $('#loading'), $logout = $('#logout');
    const $search = $('#search'), $backToList = $('#back-to-list'), $addProductBtn = $('#add-product-btn');
    
    let allProducts = [], searchTerm = "";
    const TRASH_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;

    /* -------------------- Auth & Routing -------------------- */
    onAuthStateChanged(auth, u => {
      $login.style.display = u ? 'none' : 'grid';
      $app.style.display = u ? 'grid' : 'none';
      if (u && !location.hash) location.hash = '#/products';
      router();
    });
    $loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      try { await signInWithEmailAndPassword(auth, email.value.trim(), password.value); }
      catch(err) { $loginError.textContent = "Accès non autorisé."; $loginError.classList.remove('hide'); }
    });
    $logout.addEventListener('click', () => signOut(auth));

    window.addEventListener('hashchange', router);
    $backToList.addEventListener('click', () => location.hash = '#/products');
    $addProductBtn.addEventListener('click', () => location.hash = '#/new');

    async function router() {
      const hash = location.hash || '#/products';
      const [_, route, id] = hash.split('/');
      $backToList.classList.toggle('hide', route !== 'edit' && route !== 'new');
      $addProductBtn.classList.toggle('hide', route !== 'products');
      $search.classList.toggle('hide', route !== 'products');

      showLoading();
      if (route === 'products') { await loadProductsOnce(); renderList(); }
      else if (route === 'edit' && id) { await renderFormPage(id); }
      else if (route === 'new') { renderFormPage(); }
      else { location.hash = '#/products'; }
      hideLoading();
    }
    const showLoading = () => { $view.innerHTML = ''; $view.appendChild($loading); $loading.classList.remove('hide'); }
    const hideLoading = () => $loading.classList.add('hide');

    /* -------------------- Data Fetching -------------------- */
    async function loadProductsOnce() {
      if (allProducts.length) return;
      try {
        const q = query(collection(db, "products"), orderBy("name"));
        const snap = await getDocs(q);
        allProducts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error(e); $view.innerHTML = `<div class="center text-danger">Erreur de chargement.</div>`; }
    }

    async function refreshProducts() {
      allProducts = []; await loadProductsOnce();
    }

    /* -------------------- LIST VIEW -------------------- */
    function renderList() {
      const listEl = document.createElement('div');
      listEl.className = 'list';
      const filtered = allProducts.filter(p => (p.name || '').toLowerCase().includes(searchTerm));
      if (!filtered.length) {
        $view.innerHTML = `<div class="center">Aucun produit trouvé.</div>`; return;
      }
      filtered.forEach(p => listEl.appendChild(productRow(p)));
      $view.innerHTML = ''; $view.appendChild(listEl);
    }

    function productRow(p) {
      const row = document.createElement('div');
      row.className = 'item';
      row.dataset.productId = p.id;
      row.dataset.productName = (p.name || '').toLowerCase();
      const specs = `Specs: ${p.rom||'?'}GB ROM / ${p.ram||'?'}GB RAM`;
      row.innerHTML = `
        <img class="thumb" src="${escapeAttr(p.imageUrl || '')}" alt="${escapeAttr(p.name)}" loading="lazy" />
        <div class="info" style="min-width:0;">
          <div class="title">${escapeHtml(p.name)}</div>
          <div class="sub">${escapeHtml(specs)}</div>
        </div>
        <div class="spacer"></div>
        <div class="price-line">
          <input type="number" class="price-input" value="${Number(p.price || 0)}" />
          <button class="btn btn-update">Mettre à jour</button>
        </div>
        <div class="actions">
          <button class="btn btn-edit">Éditer</button>
          <button class="btn btn-delete" title="Supprimer">${TRASH_ICON_SVG}</button>
        </div>`;
      row.querySelector('.btn-update').addEventListener('click', e => handlePriceUpdate(p.id, e.target.previousElementSibling, e.target));
      row.querySelector('.btn-edit').addEventListener('click', () => location.hash = `#/edit/${p.id}`);
      row.querySelector('.btn-delete').addEventListener('click', e => handleDelete(p.id, p.name, row));
      return row;
    }
    
    $search.addEventListener('input', e => {
      searchTerm = (e.target.value || '').toLowerCase();
      if (location.hash.startsWith('#/products')) renderList();
    });

    /* -------------------- FORM VIEW (Create/Edit) -------------------- */
    async function renderFormPage(id = null) {
      let p = {};
      if (id) {
        p = allProducts.find(prod => prod.id === id) || await getDoc(doc(db, 'products', id)).then(s => s.exists() ? {id: s.id, ...s.data()} : null);
        if (!p) { $view.innerHTML = `<div class="center text-danger">Produit introuvable.</div>`; return; }
      }
      
      const wrap = document.createElement('div');
      wrap.className = 'form-wrap';
      wrap.innerHTML = `
        <div class="form-head">
          <div class="form-title">${id ? 'Modifier le produit' : 'Ajouter un nouveau produit'}</div>
          ${id ? `<span class="kpi">ID: ${escapeHtml(p.id.slice(0,8))}…</span>` : ''}
        </div>
        <form id="product-form" class="form-main">
          <div class="field">
            <label class="label" for="p-name">Nom du produit</label>
            <input id="p-name" class="input" type="text" value="${escapeAttr(p.name || '')}" required />
          </div>
          <div class="twocol">
            <div class="field">
              <label class="label" for="p-price">Prix (FCFA)</label>
              <input id="p-price" class="input" type="number" min="0" value="${Number(p.price ?? '')}" />
            </div>
            <div class="field">
                <label class="label" for="p-brand">Marque</label>
                <input id="p-brand" class="input" type="text" value="${escapeAttr(p.brand || '')}" />
            </div>
          </div>
          <div class="twocol">
            <div class="field">
              <label class="label" for="p-ram">RAM (GB)</label>
              <input id="p-ram" class="input" type="number" min="0" step="1" value="${Number(p.ram ?? '')}" />
            </div>
            <div class="field">
              <label class="label" for="p-rom">ROM (GB)</label>
              <input id="p-rom" class="input" type="number" min="0" step="1" value="${Number(p.rom ?? '')}" />
            </div>
          </div>
          <div class="field">
            <label class="label" for="p-desc">Description</label>
            <textarea id="p-desc" class="textarea">${escapeHtml(p.description || '')}</textarea>
          </div>
          <div class="field">
            <label class="label" for="p-image">Image</label>
            <input id="p-image-file" class="input" type="file" accept="image/png, image/jpeg, image/webp" />
            <img id="p-image-preview" class="image-preview" src="${escapeAttr(p.imageUrl || '')}" style="margin-top:10px; ${p.imageUrl ? '' : 'display:none;'}" />
          </div>
          <div class="form-actions">
            <button type="button" id="cancel" class="btn btn-outline">Annuler</button>
            <button type="submit" id="save" class="btn btn-primary">${id ? 'Enregistrer' : 'Créer le produit'}</button>
          </div>
        </form>`;
      
      $view.innerHTML = ''; $view.appendChild(wrap);

      const $imgFile = $('#p-image-file'), $imgPreview = $('#p-image-preview');
      $imgFile.addEventListener('change', () => {
        const file = $imgFile.files[0];
        if (file) { $imgPreview.src = URL.createObjectURL(file); $imgPreview.style.display = 'block'; }
      });
      
      $('#cancel').addEventListener('click', () => location.hash = '#/products');
      $('#product-form').addEventListener('submit', e => handleFormSubmit(e, id));
    }

    /* -------------------- Actions (Update, Delete, Create) -------------------- */
    async function handlePriceUpdate(id, inputEl, btnEl) {
      const val = parseFloat(inputEl.value);
      if (isNaN(val) || val < 0) return alert('Prix invalide.');
      const prevHTML = btnEl.innerHTML;
      btnEl.innerHTML = '<div class="loader"></div>'; btnEl.disabled = true;
      try {
        await updateDoc(doc(db, 'products', id), { price: val });
        const p = allProducts.find(p => p.id === id); if (p) p.price = val;
        btnEl.textContent = '✓'; btnEl.style.background = 'var(--success)';
        setTimeout(() => { btnEl.innerHTML = prevHTML; btnEl.style.background = 'var(--primary)'; btnEl.disabled = false; }, 1200);
      } catch (e) { console.error(e); alert("Erreur."); btnEl.innerHTML = prevHTML; btnEl.disabled = false; }
    }

    async function handleDelete(id, name, rowEl) {
      if (!confirm(`Supprimer “${name}”?`)) return;
      rowEl.style.opacity = '.5';
      try {
        await deleteDoc(doc(db, 'products', id));
        allProducts = allProducts.filter(p => p.id !== id);
        rowEl.remove();
      } catch (e) { console.error(e); alert("Erreur."); rowEl.style.opacity = '1'; }
    }
    
    async function handleFormSubmit(e, id) {
        e.preventDefault();
        const $saveBtn = $('#save');
        const prevHTML = $saveBtn.innerHTML;
        $saveBtn.innerHTML = '<div class="loader"></div>';
        $saveBtn.disabled = true;

        const imageFile = $('#p-image-file').files[0];
        let imageUrl = id ? allProducts.find(p=>p.id===id).imageUrl : ''; // Keep old image URL if not changed

        try {
            // 1. Si une nouvelle image est sélectionnée, on l'upload d'abord
            if (imageFile) {
                const imageName = `${Date.now()}-${imageFile.name}`;
                const storageRef = ref(storage, `product-images/${imageName}`);
                const snapshot = await uploadBytes(storageRef, imageFile);
                imageUrl = await getDownloadURL(snapshot.ref);
            }

            const payload = {
                name: $('#p-name').value.trim(),
                price: parseFloat($('#p-price').value || '0'),
                brand: $('#p-brand').value.trim(),
                ram: parseInt($('#p-ram').value || '0') || null,
                rom: parseInt($('#p-rom').value || '0') || null,
                description: $('#p-desc').value.trim(),
                imageUrl: imageUrl
            };

            if (!payload.name) { throw new Error('Le nom est obligatoire.'); }

            // 2. Créer ou Mettre à jour le document Firestore
            if (id) { // Mise à jour
                await updateDoc(doc(db, "products", id), payload);
            } else { // Création
                await addDoc(collection(db, "products"), payload);
            }
            
            $saveBtn.textContent = '✓ Enregistré';
            $saveBtn.style.background = 'var(--success)';
            await refreshProducts(); // Recharger les données
            setTimeout(() => location.hash = '#/products', 800);

        } catch (error) {
            console.error("Form submit error:", error);
            alert(`Erreur : ${error.message}`);
            $saveBtn.innerHTML = prevHTML;
            $saveBtn.disabled = false;
        }
    }

    /* -------------------- Utils -------------------- */
    function escapeHtml(s = '') { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
    function escapeAttr(s = '') { return escapeHtml(s).replace('`', '&#96;'); }
  </script>
</body>
</html>
